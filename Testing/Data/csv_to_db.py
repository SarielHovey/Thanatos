import pandas as pd
from datetime import datetime as dt
import sqlite3


con = sqlite3.connect("~/Thanatos/Data/securities_master.db")
cur = con.cursor()


prices = []
symbol_list = ['600000','600004','600009','600010','600011','600015','600016','600018','600019','600023','600025','600027','600028','600029','600030','600031',
 '600036','600038','600048','600050','600061','600066','600068','600085','600089','600100','600104','600109','600111','600115','600118','600153','600170','600176',
 '600177','600183','600188','600196','600208','600219','600221','600233','600271','600276','600297','600299','600309','600332','600340','600346','600352','600362',
 '600369','600372','600383','600390','600398','600406','600436','600438','600482','600487','600489','600498','600516','600519','600522','600535','600547','600566',
 '600570','600583','600585','600588','600606','600637','600655','600660','600663','600674','600690','600703','600705','600733','600741','600760','600795','600809',
 '600816','600837','600848','600867','600886','600887','600893','600900','600919','600926','600928','600958','600968','600977','600989','600998','600999','601006',
 '601009','601012','601018','601021','601066','601088','601108','601111','601117','601138','601155','601162','601166','601169','601186','601198','601211','601212',
 '601216','601225','601229','601236','601238','601288','601298','601318','601319','601328','601336','601360','601377','601390','601398','601555','601577','601600',
 '601601','601607','601618','601628','601633','601668','601669','601688','601698','601727','601766','601788','601800','601808','601818','601828','601838','601857',
 '601877','601878','601881','601888','601898','601899','601901','601919','601933','601939','601985','601988','601989','601992','601997','601998','603019','603156',
 '603160','603259','603260','603288','603501','603799','603833','603899','603986','603993','000001','000002','000063','000069','000100','000157','000166','000333',
 '000338','000413','000415','000423','000425','000538','000568','000596','000625','000627','000629','000630','000651','000656','000661','000671','000703','000709',
 '000723','000725','000728','000768','000776','000783','000786','000858','000876','000895','000898','000938','000961','000963','001979','002001','002007','002008',
 '002010','002024','002027','002032','002044','002050','002081','002120','002142','002146','002153','002179','002202','002230','002236','002241','002252','002271',
 '002294','002304','002311','002352','002410','002411','002415','002422','002456','002460','002466','002468','002475','002493','002508','002555','002558','002594',
 '002601','002602','002607','002624','002673','002714','002736','002739','002773','002841','002916','002938','002939','002945','002958','300003','300015','300017',
 '300024','300033','300059','300070','300122','300124','300136','300142','300144','300347','300408','300413','300433','300498']

 
sym = pd.read_sql_query("SELECT id, ticker from symbol;",con = con, index_col='ticker')

for i in symbol_list:
    data = pd.read_csv(i+".csv",header=0)
    data.price_date = pd.to_datetime(data.price_date,format="%Y-%m-%d")
    sym_id = int(sym.at[i,'id'])
    for j, day in enumerate(data.price_date):
        prices.append(
            (
            3,
            sym_id,
            day.to_pydatetime(),
            dt.utcnow(),
            dt.utcnow(),
            data.iat[j,2], # d1, open_price
            data.iat[j,3], # d2, high_price
            data.iat[j,4], # d3, low_price
            data.iat[j,5], # d4, close_price
            int(data.iat[j,6]), # d5, volume
            data.iat[j,7] # d6, adj_factor
            )
        )
        
column_str = (
        "data_vendor_id, symbol_id, price_date, created_date, last_updated_date, open_price, high_price, low_price, close_price, volume, adj_factor"
    )
insert_str = ("?, " * 11)[:-2]
final_str = ("INSERT INTO daily_price (%s) VALUES (%s)" % (column_str, insert_str))
cur.executemany(final_str, prices)
con.commit()
con.close()
